(()=>{"use strict";var e={187:e=>{var t,n="object"==typeof Reflect?Reflect:null,r=n&&"function"==typeof n.apply?n.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};t=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var i=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}e.exports=o,e.exports.once=function(e,t){return new Promise((function(n,r){function i(n){e.removeListener(t,o),r(n)}function o(){"function"==typeof e.removeListener&&e.removeListener("error",i),n([].slice.call(arguments))}v(e,t,o,{once:!0}),"error"!==t&&function(e,t,n){"function"==typeof e.on&&v(e,"error",t,{once:!0})}(e,i)}))},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var s=10;function u(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function a(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function c(e,t,n,r){var i,o,s,c;if(u(n),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),s=o[t]),void 0===s)s=o[t]=n,++e._eventsCount;else if("function"==typeof s?s=o[t]=r?[n,s]:[s,n]:r?s.unshift(n):s.push(n),(i=a(e))>0&&s.length>i&&!s.warned){s.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=s.length,c=l,console&&console.warn&&console.warn(c)}return e}function l(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function f(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=l.bind(r);return i.listener=n,r.wrapFn=i,i}function h(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):y(i,i.length)}function p(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function y(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function v(e,t,n,r){if("function"==typeof e.on)r.once?e.once(t,n):e.on(t,n);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function i(o){r.once&&e.removeEventListener(t,i),n(o)}))}}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return s},set:function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");s=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return a(this)},o.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i="error"===e,o=this._events;if(void 0!==o)i=i&&void 0===o.error;else if(!i)return!1;if(i){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var u=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw u.context=s,u}var a=o[e];if(void 0===a)return!1;if("function"==typeof a)r(a,this,t);else{var c=a.length,l=y(a,c);for(n=0;n<c;++n)r(l[n],this,t)}return!0},o.prototype.addListener=function(e,t){return c(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return c(this,e,t,!0)},o.prototype.once=function(e,t){return u(t),this.on(e,f(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return u(t),this.prependListener(e,f(this,e,t)),this},o.prototype.removeListener=function(e,t){var n,r,i,o,s;if(u(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){s=n[o].listener,i=o;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,s||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,o=Object.keys(n);for(r=0;r<o.length;++r)"removeListener"!==(i=o[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},o.prototype.listeners=function(e){return h(this,e,!0)},o.prototype.rawListeners=function(e){return h(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},o.prototype.listenerCount=p,o.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var o=t[r]={exports:{}};return e[r](o,o.exports,n),o.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var r={};(()=>{n.r(r),n.d(r,{CabinetClient:()=>s,CabinetProvider:()=>l,space:()=>J,useShelf:()=>h});var e=n(187),t=new(n.n(e)());t.setMaxListeners(0);var i={},o="undefined"!=typeof window;const s=function(e){var n=this;this.messages=[],this.connection=null,this.cabinet=e.cabinet,this.accessToken=e.accessToken,this.onmessage=function(e){var r=JSON.parse(e.data),o=r.type,s=r.data;if("get"===o){var u=s.key,a=s.patches;!function(e,n){i[e]=n,t.emit(e,n)}(u,s.users),n.cabinet.applyOps(u,a)}},this.onopen=function(e){n.messages.forEach((function(e){n.sendMessage(e)}))},this.onclose=function(e){Object.keys(i).forEach((function(e){t.emit(e,[])})),i={},n.createConnection()},this.createConnection=function(){n.connection=new WebSocket(e.uri),n.connection.onmessage=n.onmessage,n.connection.onopen=n.onopen,n.connection.onclose=n.onclose},o&&this.createConnection(),this.sendMessage=function(e){var t;if((null===(t=n.connection)||void 0===t?void 0:t.readyState)===WebSocket.OPEN)n.connection.send(JSON.stringify(e));else{if("set"===e.type){var r=n.messages.find((function(t){return e.data.key===t.data.key}));if(r)return void r.data.patches.push(e.data.patches)}n.messages.push(e)}},this.subscribe=function(e,t){n.sendMessage({type:"subscribe",accessToken:n.accessToken,data:{cabinet:n.cabinet.name,key:e,patches:t}})},this.unsubscribe=function(e){n.sendMessage({type:"unsubscribe",accessToken:n.accessToken,data:{cabinet:n.cabinet.name,key:e}})},this.uri=e.uri},u=require("react");var a=n.n(u);const c=(0,u.createContext)({client:null,cabinet:null,addSubscription:null,removeSubscription:null}),l=function(e){var t=e.client,n=e.children,r=(0,u.useCallback)((function(e,n){null==t||t.cabinet.getShelf(e).then((function(r){t.subscribe(e,r.history),t.cabinet.addSubscription(e,n)}))}),[t]),i=(0,u.useCallback)((function(e,n){null==t||t.cabinet.removeSubscription(e,n),null==t||t.unsubscribe(e)}),[t]),o={client:t,cabinet:null==t?void 0:t.cabinet,addSubscription:r,removeSubscription:i};return a().createElement(c.Provider,{value:o},n)};function f(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}const h=function(e){var t,n,r=(t=(0,u.useState)(null),n=2,function(e){if(Array.isArray(e))return e}(t)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,o=[],s=!0,u=!1;try{for(n=n.call(e);!(s=(r=n.next()).done)&&(o.push(r.value),!t||o.length!==t);s=!0);}catch(e){u=!0,i=e}finally{try{s||null==n.return||n.return()}finally{if(u)throw i}}return o}}(t,n)||function(e,t){if(e){if("string"==typeof e)return f(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?f(e,t):void 0}}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),i=r[0],o=r[1],s=(0,u.useContext)(c),a=s.client,l=s.cabinet,h=s.addSubscription,p=s.removeSubscription,y=(0,u.useCallback)((function(e,t,n){JSON.stringify(n.value)!==JSON.stringify(i)&&o(n.value)}),[e]),v=(0,u.useCallback)((function(t){l.setState(e,t).then((function(t){a.sendMessage({accessToken:a.accessToken,type:"set",data:{cabinet:l.name,key:e,patches:t}})}))}),[e,l,a]);return(0,u.useEffect)((function(){return h(e,y),function(){p(e,y)}}),[e,y]),[i,v]},p="object",y="array",v={object:0,array:1,string:2,number:3,boolean:4,null:5,other:6},d=e=>v[m(e)],m=e=>null===e?"null":Array.isArray(e)?y:Object.keys(v).includes(typeof e)?typeof e:"other",b=(e,t)=>{if(0===t.length)return Array.isArray(e)?e[1]:e;let n=e;return t.forEach((e=>{n=Array.isArray(n)?n[0][e]:n[e]})),Array.isArray(n)?n[1]:n||0},g=(e,t)=>e===p?[{},t]:e===y?[[],t]:t,S=(e,t,n)=>({key:e,type:"set",value:t,version:n}),w=(e=null)=>{const t={value:null,versions:0,history:[]};if(e){const n=_(t.value,e,0);return L(t,n)}return t},O=(e,t)=>{const n=(r=e,JSON.parse(JSON.stringify(r)));var r;return"set"===t.type?((e,t)=>{const n=((e,t)=>{if(0===t.length)return e;if(null===e)return;let n=e;for(let e=0;e<t.length-1;e++)if(n=n[t[e]],null==n)return;return n=n[t[t.length-1]],n})(e.value,t.key);if(void 0===n)return!0;const r=b(e.versions,t.key);return r<t.version||r===t.version&&1===((e,t)=>{const n=d(e),r=d(t);if(n<r)return 1;if(n>r)return-1;if(n===v.object)return 0;if(n===v.array||n===v.other){const n=JSON.stringify(e),r=JSON.stringify(t);return n===r?0:n<r?1:-1}return e===t?0:e<t?1:-1})(n,t.value)})(n,t)&&(((e,t)=>{const n=e.history.findIndex((e=>JSON.stringify(e.key)===JSON.stringify(t.key)));-1===n?e.history.push(t):e.history[n]=t})(n,t),((e,t)=>{e.versions=((e,t,n,r)=>{if(0===t.length)return g(r,n);let i=e;for(let e=0;e<t.length-1;e++)i=Array.isArray(i)?i[0][t[e]]:i[t[e]];return Array.isArray(i)?i[0][t[t.length-1]]=g(r,n):i[t[t.length-1]]=g(r,n),e})(e.versions,t.key,t.version,m(t.value)),e.value=((e,t,n)=>{if(0===t.length)return n;let r=e;for(let e=0;e<t.length-1;e++)r=r[t[e]];return r[t[t.length-1]]=n,e})(e.value,t.key,t.value)})(n,t)):"insert"===t.type||t.type,n},L=(e,t)=>{let n=e;return t.forEach((e=>{n=O(n,e)})),n},k=(e,t=1,n=[],r=[])=>{const i=m(e);return i===p?(r.push(S(n,{},t)),[...new Set([...Object.keys(e)])].forEach((i=>{k(e[i]??null,t,[...n,i],r)}))):i===y?(r.push(S(n,[],t)),e.forEach(((i,o)=>{k(e[o]??null,t,[...n,o],r)}))):r.push(S(n,e,t)),r},_=(e,t,n,r=[],i=[])=>{if(JSON.stringify(e)===JSON.stringify(t))return i;if(void 0===e)return i.push(...k(t,1,r)),i;const o=m(e),s=m(t);if(null===e)return i.push(...k(t,b(n,r)+1,r)),i;if(o===p&&s===p)return[...new Set([...Object.keys(e),...Object.keys(t)])].forEach((o=>{_(e[o]??null,t[o]??null,n,[...r,o],i)})),i;if(o===y&&s===y){const o=Math.max(e.length,t.length);for(let s=0;s<o;s++)_(e[s]??null,t[s]??null,n,[...r,s],i);return i}return i.push(S(r,t,b(n,r)+1)),i};function x(t,n){this.emitter=new e,this.emitter.setMaxListeners(0),this.repository=t,this.name=n,this.store={}}x.prototype.getSubscribedKeys=function(){return Object.keys(this.store)},x.prototype.getKeys=async function(){return await this.repository.getKeys(this.name)},x.prototype.removeShelf=function(e){delete this.store[e]},x.prototype.deleteShelf=async function(e){delete this.store[e],await this.repository.removeShelf(this.name,e)},x.prototype.getState=async function(e){return this.store[e]?.value||await this.repository.getShelfByKey(this.name,e).value||w().value},x.prototype.getShelf=async function(e){return this.store[e]||await this.repository.getShelfByKey(this.name,e)||w()},x.prototype.setState=async function(e,t){let n=await this.getShelf(e);if(n){const r=_(n.value,t,n.versions),i=L(n,r);return this.setShelf(e,i,r),r}return n=w(t),this.setShelf(e,n,n.history),n.history},x.prototype.setShelf=function(e,t,n){this.store[e]=t,this.repository.setShelfByKey(this.name,e,t),this.emitter.emit(e,this.name,e,t,n)},x.prototype.applyOp=async function(e,t){let n=await this.getShelf(e);this.setShelf(e,O(n||w(),t),[t])},x.prototype.applyOps=async function(e,t){const n=await this.getShelf(e);this.setShelf(e,L(n||w(),t),t)},x.prototype.initShelf=async function(e){const t=await this.repository.getShelfByKey(this.name,e);t&&this.setShelf(e,t,t.history)},x.prototype.addSubscription=function(e,t){this.store[e]||this.initShelf(e),this.emitter.addListener(e,t)},x.prototype.removeSubscription=function(e,t){this.emitter.removeListener(e,t),0===this.emitter.listenerCount(e)&&this.removeShelf(e)},x.prototype.getSubscriptionCount=function(e){this.emitter.listenerCount(e)};const j=x;function C(e){this.repository=e,this.cabinets={}}C.prototype.getCabinet=function(e){return void 0===this.cabinets[e]&&(this.cabinets[e]=new j(this.repository,e)),this.cabinets[e]};const E=C;function A(e,t,n,r,i,o,s){try{var u=e[o](s),a=u.value}catch(e){return void n(e)}u.done?t(a):Promise.resolve(a).then(r,i)}function N(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var o=e.apply(t,n);function s(e){A(o,r,i,s,u,"next",e)}function u(e){A(o,r,i,s,u,"throw",e)}s(void 0)}))}}var M=function(){var e=N(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",[]);case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),P=function(){var e=N(regeneratorRuntime.mark((function e(t,n){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("undefined"!=typeof window){e.next=2;break}return e.abrupt("return",null);case 2:return r=window.localStorage.getItem("".concat(t).concat(n)),e.abrupt("return",r&&JSON.parse(r)||null);case 4:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),T=function(){var e=N(regeneratorRuntime.mark((function e(t,n,r){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("undefined"!=typeof window){e.next=2;break}return e.abrupt("return",null);case 2:localStorage.setItem("".concat(t).concat(n),JSON.stringify(r));case 3:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}();const J=new E({getKeys:M,getShelfByKey:P,setShelfByKey:T})})(),module.exports=r})();